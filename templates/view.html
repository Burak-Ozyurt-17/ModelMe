{% extends "layout.html" %}
{% block title_name %}View Model{% endblock %}
{% block main %}

<div id="loading-screen" class="loading-screen">
    <div class="spinner"></div>
    <div class="loading-text">Loading...</div>
</div>

<div class="model-info-box">
    <div class="model-title">{{ model.title }}</div>
    <div class="model-creator">by: {{ creator }}</div>
    <div class="model-description">Description: {{ model.description }}</div>
</div>

    <div id="results-container-view">
        <div id="results-content">
            <video id="webcam" autoplay muted style="width:100%;height:auto"></video>
        </div>
        <div class="output-container">
            <div id="prediction-container"></div>
        </div>
    </div>
    <button 
        id="copy-url-btn" 
        onclick="copy_url()" 
        title="Copy model URL to clipboard"
        aria-label="Copy model URL">
        <img 
            src="{{ url_for('static', filename='url (1).png') }}" 
            alt="Copy link icon" 
            class="copy-icon">
    </button>
    <button
        id="download-model"
        onclick="download_model()" 
        title="Download model file as zip"
        aria-label="Download model URL">
        <img 
            src="{{ url_for('static', filename='download-model.png') }}" 
            alt="Download link icon" 
            class="copy-icon">
</button>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
    window.modelId = "{{model_id}}"
    
    function copy_url(){
        navigator.clipboard.writeText(window.location.href);
        document.getElementById("copy-url-btn").style.backgroundColor = "#198754"
    }
    function download_model(){
        // Used JSZip https://stuk.github.io/jszip/

        var zip = new JSZip();
        zip.file("Copyright.txt","Copyright (c) 2025 ModelMe \n\nAll rights reserved.\n\nThis model is provided for personal and educational use only.\nYou may not copy, distribute, modify, or use this model for commercial purposes\nwithout explicit written permission from the copyright holder")
        // A temporary copyright text 

        var modelFolder = zip.folder("{{ model.title }}");
        // Example: add model files (replace with your actual src paths)
        const files = [
            "/static/models/{{ model_id }}/model.json",
            "/static/models/{{ model_id }}/class_names.json",
            "/static/models/{{ model_id }}/weights.bin"
        ];
        // Fetch each file and add to zip
        Promise.all(
            files.map(url => 
                fetch(url)
                .then(res => res.blob())
                .then(blob => {
                    let filename = url.split("/").pop(); // get only file name
                    modelFolder.file(filename, blob);
                })
            )
        ).then(() => {
            // Generate the zip once all files are added
            zip.generateAsync({ type: "blob" })
            .then(function(content) {
                saveAs(content, "{{ model_id }}.zip");
        });

        document.getElementById("download-model").style.backgroundColor = "#198754";
    });
}

    
</script>
<script type="module" src="/static/predict.js"></script>

{% endblock %}

